---
title: "Drug A"
author: "Chris Beeley"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(lubridate)
library(fable)
library(tibbletime)
library(feasts)
library(tsibble)
library(sweep)
library(knitr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      results = "asis")

load("pharmacy.rda")

# summarise by week- keep this

drug <- pharmacy %>% 
  filter(NSVCode == "Drug A") %>% 
  mutate(Date = floor_date(Date, "week"),
         Date = yearweek(Date)) %>% 
  group_by(Date) %>% 
  summarise(quantity = sum(Total_Qty, na.rm = TRUE)) %>% 
  ungroup() %>%  
  tsibble(index = Date) %>% 
  fill_gaps(sum = 0)

```

## Introduction

Methods

* SES
* ARIMA
* (More to be added)

## Yearly seasonality

```{r}

# summarise by month- don't save this output

pharmacy %>%
  filter(NSVCode == "Drug A") %>%
  mutate(Date = floor_date(Date, "month"),
         Date = yearmonth(Date)) %>%
  group_by(Date) %>%
  summarise(quantity = sum(Total_Qty, na.rm = TRUE)) %>%
  ungroup() %>%
  tsibble(index = Date) %>%
  fill_gaps(quantity = 0) %>%
  gg_season()

```

## Weekly summary

```{r}

drug %>%
  model(STL(quantity ~ trend(window = 11) + season("1 year"),
            robust = TRUE)) %>%
  components() %>%
  autoplot() + 
  ggtitle("All data STL decomposition")

```

## Simple exponential smoothing

```{r}

fit_ets <- drug %>% 
  model(ETS(quantity))

fit_ets %>% 
  sw_tidy() %>% 
  kable()

fit_ets %>% 
  gg_tsresiduals(lag_max = 16)

```

Ljung Box test for autocorrelation of residuals

```{r}

augment(fit_ets) %>%
  features(.resid, ljung_box, lag = 16, dof = 6) %>% 
  kable()

```

Residuals show autocorrelation (p<.05)

## ARIMA

```{r}

drug %>%
  model(
    ARIMA(quantity),
    MEAN(quantity),
    SNAIVE(quantity)
  ) %>%
  forecast(h = 10) %>% 
  autoplot(drug, level = NULL)

drug %>% 
  model(ARIMA(quantity)) %>% 
  forecast(h = 10) %>% 
  autoplot(drug)

fit_arima <- drug %>% 
  model(ARIMA(quantity))

cat("Model terms  \n")

fit_arima %>% 
  sw_tidy() %>% 
  kable()

gg_tsresiduals(fit_arima, lag_max = 16)

```

Ljung Box test for autocorrelation of residuals

```{r}

fit_arima %>%
  augment() %>% 
  features(.resid, ljung_box, lag = 16, dof = 6) %>% 
  kable()

```

No autocorrelation of residuals (p>.05)

Forecast accuracy

```{r}

drug %>%
  slice(-n()) %>%
  model(
    MEAN(quantity),
    ARIMA(quantity),
    SNAIVE(quantity, lag = "1 year")
  ) %>%
  forecast(h = 1) %>%
  accuracy(drug) %>% 
  select(-ACF1) %>% 
  kable()

```

