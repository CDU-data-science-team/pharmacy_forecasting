---
title: "Drug B"
author: "Chris Beeley"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(lubridate)
library(fable)
library(tibbletime)
library(feasts)
library(tsibble)
library(sweep)
library(knitr)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      results = "asis")

load("pharmacy.rda")

# summarise by week- keep this

drug <- pharmacy %>% 
  filter(NSVCode == "Drug B") %>% 
  mutate(Date = floor_date(Date, "week"),
         Date = yearweek(Date)) %>% 
  group_by(Date) %>% 
  summarise(quantity = sum(Total_Qty, na.rm = TRUE)) %>% 
  ungroup() %>%  
  tsibble(index = Date) %>% 
  fill_gaps(sum = 0)

```

## Introduction

Methods

* SES
* ARIMA
* (More to be added)

## Summary

```{r}

drug %>%
  model(STL(quantity ~ trend(window = 11) + season("1 year"),
            robust = TRUE)) %>%
  components() %>%
  autoplot() + 
  ggtitle("All data STL decomposition")

```

## Yearly seasonality

```{r}

# summarise by month- don't save this output

pharmacy %>%
  filter(NSVCode == "Drug A") %>%
  mutate(Date = floor_date(Date, "month"),
         Date = yearmonth(Date)) %>%
  group_by(Date) %>%
  summarise(quantity = sum(Total_Qty, na.rm = TRUE)) %>%
  ungroup() %>%
  tsibble(index = Date) %>%
  fill_gaps(quantity = 0) %>%
  gg_season()

```

## Simple exponential smoothing

```{r}

fit_ets <- drug %>% 
  model(ETS(quantity))

fit_ets %>% 
  sw_tidy() %>% 
  kable()

fit_ets %>% 
  gg_tsresiduals(lag_max = 16)

```

Ljung Box test for autocorrelation of residuals

```{r}

augment(fit_ets) %>%
  features(.resid, ljung_box, lag = 16, dof = 6) %>% 
  kable()

```

Residuals show no autocorrelation (p>.05)

## ARIMA

```{r, cache = TRUE}

drug_train <- drug %>% 
  head(-10)

drug_model <- drug_train %>% 
  model(MEAN(quantity),
        SNAIVE(quantity), 
        ARIMA(quantity),
        ETS(quantity)) %>% 
  forecast(h = 10)

drug_model %>% 
  autoplot(drug, level = NULL)

cat("Model terms  \n")

arima_drug <- drug %>% 
  model(ARIMA(quantity, approximation = FALSE))

arima_drug %>% 
  sw_tidy() %>% 
  kable()

gg_tsresiduals(arima_drug, lag_max = 16)

```

The model returned is ARIMA(1,0,1)(1,0,0). It may be that this model is more complicated than we need.

Ljung Box test for autocorrelation of residuals

```{r}

arima_drug %>%
  augment() %>% 
  features(.resid, ljung_box, lag = 16, dof = 6) %>% 
  kable()

```

No autocorrelation of residuals (p>.05)

Forecast accuracy

```{r, cache = TRUE}

drug_model %>% 
  accuracy(drug) %>% 
  mutate(across(where(is.numeric), signif, 5)) %>% 
  select(-ACF1) %>%
  kable()

```

